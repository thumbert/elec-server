


CREATE TEMPORARY TABLE tbl (
    date DATE,
    id INT,
    price DECIMAL(9,4)[]
);
INSERT INTO tbl VALUES
    ('2025-07-01', 4000, [1.3456, 2.4567]),
    ('2025-07-01', 4001, [14.5678, 15.6789]),
    ('2025-07-02', 4000, [1.7890, 2.8901]),
    ('2025-07-02', 4001, [19.0123, 20.1234]);


-- Construct the json output by hand... 
WITH per_date AS (
    SELECT
        date,
         '{' || string_agg(id || ':' || to_json(price), ',') || '}' AS map_json
    FROM tbl
    GROUP BY date
    ORDER BY date
)
SELECT '{' || string_agg('"' || date || '":' || map_json, ',') || '}' AS out
FROM per_date;
-- ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
-- │                                                          out                                                           │
-- │                                                        varchar                                                         │
-- ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
-- │ {"2025-07-01":{4000:[1.3456,2.4567],4001:[14.5678,15.6789]},"2025-07-02":{4000:[1.789,2.8901],4001:[19.0123,20.1234]}} │
-- └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
